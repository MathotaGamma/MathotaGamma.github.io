<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <title>three.js チュートリアルプレイグラウンド</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- CodeMirror 5（CDN） -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>
    <style>
      html, body {
        height: 100%;
        margin: 0;
        background: #000;
        color: #eee;
        font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans JP", sans-serif;
      }
      /* 2カラム：左=エディタ, 右=プレビュー */
      .app {
        display: flex;
        height: 100%;
        width: 100%;
        overflow: hidden;
      }
      .left {
        width: 50%;
        min-width: 360px;
        display: flex;
        flex-direction: column;
        border-right: 1px solid #222;
        background: #000;
      }
      .right {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: #000;
      }
      /* 操作バー */
      .toolbar {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px;
        border-bottom: 1px solid #222;
        background: #0b0b0b;
      }
      .toolbar label, .toolbar span {
        font-size: 12px;
        color: #bbb;
      }
      .toolbar input, .toolbar select, .toolbar button {
        height: 28px;
        border-radius: 6px;
        border: 1px solid #333;
        background: #111;
        color: #eee;
        padding: 0 8px;
      }
      .toolbar button {
        background: #1e1e1e;
        cursor: pointer;
      }
      .toolbar button:hover {
        background: #2a2a2a;
      }
      /* CodeMirror の見た目（背景黒） */
      .editor {
        position: relative;
        flex: 1;
        min-height: 0;
      }
      .CodeMirror {
        height: 100%;
        background: #000 !important;
        color: #eee !important;
        font-size: 14px;
        line-height: 1.5;
      }
      .CodeMirror-gutters {
        background: #000 !important;
        border-right: 1px solid #222 !important;
        color: #666;
      }
      .CodeMirror-cursor {
        border-left: 2px solid #fff !important;
      }
      /* 右側の iframe（キャンバス）100% */
      .stage {
        flex: 1;
        min-height: 0;
        position: relative;
        background: #000;
        border-bottom: 1px solid #111;
      }
      .stage iframe {
        display: block;
        width: 100%;
        height: 100%;
        border: 0;
        background: #000;
      }
      /* コンソール */
      .console {
        height: 160px;
        background: #0b0b0b;
        color: #ddd;
        font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
        font-size: 12px;
        line-height: 1.5;
        overflow: auto;
        padding: 8px;
      }
      .log { color: #90ee90; }
      .error { color: #ff6b6b; }
      .info { color: #9ad; }
    </style>
  </head>
  <body>
    <div class="app">
      <!-- 左：エディタ＋コンソール -->
      <section class="left">
        <div class="toolbar">
          <button id="runBtn">実行</button>
          <button id="clearBtn">コンソールクリア</button>
          <span>インデント幅</span>
          <select id="indentSize">
            <option value="2" selected>2</option>
            <option value="4">4</option>
            <option value="8">8</option>
          </select>
          <span>タブ</span>
          <select id="tabBehavior">
            <option value="spaces" selected>スペース</option>
            <option value="indent">インデント/選択範囲</option>
          </select>
        </div>
        <div class="editor" id="editor"></div>
        <div class="console" id="console"></div>
      </section>

      <!-- 右：実行結果（iframe内でthree.jsを実行） -->
      <section class="right">
        <div class="stage">
          <iframe id="sandbox" sandbox="allow-scripts"></iframe>
        </div>
      </section>
    </div>

    <script>
      // --- CodeMirror 初期化 ---
      const editorHost = document.getElementById('editor');
      const cm = CodeMirror(editorHost, {
        value:
`// THREE グローバル版で基本サンプル（背景は黒）
// 右側の領域いっぱいに自動リサイズします。
console.log("Hello from iframe!");

const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(60, 1, 0.1, 1000);

const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setPixelRatio(window.devicePixelRatio);
document.body.appendChild(renderer.domElement);

// 立方体
const geo = new THREE.BoxGeometry(1, 1, 1);
const mat = new THREE.MeshNormalMaterial();
const cube = new THREE.Mesh(geo, mat);
scene.add(cube);

camera.position.set(2, 1.5, 3);
camera.lookAt(0, 0, 0);

function resize() {
  const w = window.innerWidth;
  const h = window.innerHeight;
  renderer.setSize(w, h);
  camera.aspect = w / h;
  camera.updateProjectionMatrix();
}
window.addEventListener('resize', resize);
resize();

function animate() {
  requestAnimationFrame(animate);
  cube.rotation.x += 0.01;
  cube.rotation.y += 0.02;
  renderer.render(scene, camera);
}
animate();`,
        mode: 'javascript',
        lineNumbers: true,
        tabSize: 2,            // 初期は2
        indentUnit: 2,         // 初期は2
        indentWithTabs: false, // スペースでインデント
        smartIndent: true
      });

      // 背景黒で見やすいようにトークン色を少し補強（最低限）
      const style = document.createElement('style');
      style.textContent = `
        .cm-keyword { color: #c586c0 !important; }
        .cm-number { color: #b5cea8 !important; }
        .cm-def { color: #9cdcfe !important; }
        .cm-string { color: #ce9178 !important; }
        .cm-variable, .cm-variable-2 { color: #d4d4d4 !important; }
        .cm-property { color: #9cdcfe !important; }
        .cm-operator { color: #d4d4d4 !important; }
        .cm-comment { color: #6a9955 !important; }
      `;
      document.head.appendChild(style);

      // ツール群
      const sandbox = document.getElementById('sandbox');
      const runBtn = document.getElementById('runBtn');
      const clearBtn = document.getElementById('clearBtn');
      const consoleDiv = document.getElementById('console');
      const indentSizeSel = document.getElementById('indentSize');
      const tabBehaviorSel = document.getElementById('tabBehavior');

      // インデント幅の反映
      function applyIndentSize(size) {
        const n = parseInt(size, 10) || 2;
        cm.setOption('tabSize', n);
        cm.setOption('indentUnit', n);
      }
      indentSizeSel.addEventListener('change', () => applyIndentSize(indentSizeSel.value));
      applyIndentSize(indentSizeSel.value);

      // Tab の挙動
      cm.setOption('extraKeys', {
        Tab(cmInst) {
          if (tabBehaviorSel.value === 'indent' && cmInst.somethingSelected()) {
            cmInst.indentSelection('add');
            return;
          }
          const n = cmInst.getOption('indentUnit') || 2;
          cmInst.replaceSelection(' '.repeat(n), 'end');
        },
        'Shift-Tab'(cmInst) {
          cmInst.indentSelection('subtract');
        }
      });

      // ペースト時：タブ→スペース & 2行目以降に貼り付け先行のインデントを付与
      cm.on('beforeChange', (instance, change) => {
        if (change.origin !== 'paste') return;
        const n = cm.getOption('indentUnit') || 2;
        const spaces = ' '.repeat(n);
        const from = change.from;
        const baseIndent = (cm.getLine(from.line).match(/^\s*/)||[''])[0];

        const lines = change.text.map((ln, i) => {
          const replaced = ln.replace(/\t/g, spaces);
          return i === 0 ? replaced : baseIndent + replaced;
        });
        change.update(change.from, change.to, lines, change.origin);
      });

      // コンソール出力補助
      function addConsoleLine(msg, cls = 'log') {
        const div = document.createElement('div');
        div.className = cls;
        div.textContent = msg;
        consoleDiv.appendChild(div);
        consoleDiv.scrollTop = consoleDiv.scrollHeight;
      }
      clearBtn.addEventListener('click', () => {
        consoleDiv.innerHTML = '';
      });

      // iframe からの postMessage を受ける
      window.addEventListener('message', (e) => {
        if (!e.data || !e.data.type) return;
        if (e.data.type === 'log') addConsoleLine(e.data.message, 'log');
        if (e.data.type === 'error') addConsoleLine(e.data.message, 'error');
        if (e.data.type === 'info') addConsoleLine(e.data.message, 'info');
      });

      // 実行：押したらコンソールをクリア → iframe を再生成
      runBtn.addEventListener('click', () => {
        consoleDiv.innerHTML = ''; // 押したらクリア
        const userCode = cm.getValue();

        const html = `
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <style>
      html, body { margin:0; height:100%; background:#000; }
      canvas { display:block; }
    </style>
    <script>
      // console のブリッジ
      (function() {
        const send = (type, args) => parent.postMessage({ type, message: Array.from(args).map(a => {
          try { return typeof a === 'object' ? JSON.stringify(a) : String(a); }
          catch(e){ return String(a); }
        }).join(' ') }, '*');
        const origLog = console.log;
        const origErr = console.error;
        const origInfo = console.info;
        console.log = function(){ send('log', arguments); origLog.apply(console, arguments); };
        console.error = function(){ send('error', arguments); origErr.apply(console, arguments); };
        console.info = function(){ send('info', arguments); origInfo.apply(console, arguments); };
        window.onerror = function(msg, src, line, col, err){
          send('error', [msg + ' (' + line + ':' + col + ')']);
        };
      })();
    <\/script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.156.1/build/three.min.js"><\/script>
  </head>
  <body>
    <script>
      try {
${userCode.split('\n').map(l => '        ' + l).join('\n')}
      } catch (e) {
        console.error(e && e.stack ? e.stack : String(e));
      }
    <\/script>
  </body>
</html>`.trim();

        // iframe を差し替えて常に 100% 埋める
        const blob = new Blob([html], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        sandbox.src = url;
      });

      // 初回自動実行
      runBtn.click();
    </script>
  </body>
</html>

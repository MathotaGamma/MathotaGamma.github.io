<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <title>three.js Tutorial Editor</title>
    <style>
      html, body {
        width: 100vw;
        margin: 0;
        display: flex;
        height: 100vh;
        overflow: hidden;
        font-family: sans-serif;
      }
      #editor-container {
        width: 50%;
        height: 100vh;
        display: flex;
        flex-direction: column;
        border-right: 4px solid #aaa;
        box-sizing: border-box;
        position: relative;
        transition: width 0.2s;
      }
      #resize-bar {
        width: 8px;
        cursor: ew-resize;
        background: #aaa;
        position: absolute;
        top: 0;
        right: -4px;
        bottom: 0;
        z-index: 10;
        touch-action: none;
        transition: opacity 0.2s;
      }
      #controls {
        padding: 6px;
        background: #f7f7f7;
        border-bottom: 1px solid #ccc;
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        align-items: center;
      }
      #controls select, #controls button {
        font-size: 14px;
        padding: 4px 8px;
        border-radius: 4px;
        border: 1px solid #888;
        background: #fff;
        cursor: pointer;
        transition: 0.2s;
      }
      #controls button:hover {
        background: #e0e0e0;
      }
      #code {
        flex: 1;
        width: 100%;
        font-family: monospace;
        font-size: 14px;
        padding: 8px;
        box-sizing: border-box;
        border: none;
        outline: none;
        resize: none;
        line-height: 1.4em;
        white-space: pre;
        overflow: auto;
      }
      #canvas-container {
        width: 50%;
        height: 100%;
        position: relative;
        display: flex;
        flex-direction: column;
        transition: width 0.2s;
      }
      #canvas-controls {
        padding: 6px;
        background: #f7f7f7;
        border-bottom: 1px solid #ccc;
        display: flex;
        gap: 6px;
        z-index: 5;
      }
      #canvas-controls button {
        font-size: 14px;
        padding: 4px 8px;
        border-radius: 4px;
        border: 1px solid #888;
        background: #fff;
        cursor: pointer;
        transition: 0.2s;
      }
      #canvas-controls button:hover {
        background: #e0e0e0;
      }
      #preview {
        width: 100%;
        flex: 1;
        border: none;
        background: grey;
        transition: opacity 0.2s;
      }
      #console {
        height: 150px;
        overflow-y: auto;
        background: #111;
        color: #0f0;
        font-family: monospace;
        font-size: 13px;
        padding: 4px;
        border-top: 1px solid #444;
      }
      #expand-button {
        position: fixed;
        top: 10px;
        right: 10px;
        z-index: 999;
        display: none;
        font-size: 14px;
        padding: 6px 12px;
        border-radius: 5px;
        border: 1px solid #888;
        background: #fff;
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        transition: 0.2s;
      }
      #expand-button:hover {
        background: #e0e0e0;
      }
    </style>
  </head>
  <body>
    <div id="editor-container">
      <div id="controls">
        <button>‚Ü©Ô∏é „Éõ„Éº„É†„Å∏</button>
        „Ç§„É≥„Éá„É≥„Éà:
        <select id="indent-size">
          <option value="2">2</option>
          <option value="4">4</option>
          <option value="8">8</option>
          <option value="tab">Tab</option>
        </select>
        <button id="run">‚ñ∂ ÂÆüË°å</button>
        <button id="clear">üóë „ÇØ„É™„Ç¢</button>
        <button id="copy">üìã „Ç≥„Éî„Éº</button>
        <button id="save">üíæ ‰øùÂ≠ò</button>
        <button id="load">üìÇ Âëº„Å≥Âá∫„Åó</button>
      </div>
      <textarea id="code">import * as THREE from "three";

// „Åì„Åì„Å´three.js„ÅÆ„Ç≥„Éº„Éâ„ÇíÊõ∏„ÅÑ„Å¶„Åè„Å†„Åï„ÅÑ

// „Ç∑„Éº„É≥‰ΩúÊàê
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x202020);

// „Ç´„É°„É©‰ΩúÊàê
const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 100);
camera.position.set(0, 3, 10);
camera.lookAt(0, 0, 0);

// „É¨„É≥„ÉÄ„É©„Éº‰ΩúÊàê
const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

// ÂÖâÊ∫ê
const ambientLight = new THREE.AmbientLight(0xffffff, 0.4);
scene.add(ambientLight);

const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
directionalLight.position.set(5, 10, 7.5);
scene.add(directionalLight);

// Box‰ΩúÊàê
const geometry = new THREE.BoxGeometry(1, 1, 1);
const material = new THREE.MeshStandardMaterial({
  color: 0x00ff00,
  roughness: 0.4,
  metalness: 0.1
});
const box = new THREE.Mesh(geometry, material);
scene.add(box);

// „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
function animate() {
  requestAnimationFrame(animate);
  box.rotation.x += 0.01;
  box.rotation.y += 0.01;
  renderer.render(scene, camera);
}
animate();

// „Ç¶„Ç£„É≥„Éâ„Ç¶„É™„Çµ„Ç§„Ç∫ÂØæÂøú
window.addEventListener('resize', () => {
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
});</textarea>
      <div id="resize-bar"></div>
      <div id="console"></div>
    </div>

    <div id="canvas-container">
      <div id="canvas-controls">
        <button id="toggle-canvas">Êäò„Çä„Åü„Åü„ÇÄ</button>
        <button id="fullscreen-canvas">ÂÖ®ÁîªÈù¢Ë°®Á§∫</button>
      </div>
      <iframe id="preview"></iframe>
    </div>
    <button id="expand-button">Â±ïÈñã</button>

    <script>
      const textarea = document.getElementById("code");
      const runBtn = document.getElementById("run");
      const clearBtn = document.getElementById("clear");
      const copyBtn = document.getElementById("copy");
      const saveBtn = document.getElementById("save");
      const loadBtn = document.getElementById("load");
      const preview = document.getElementById("preview");
      const consoleDiv = document.getElementById("console");
      const indentSelect = document.getElementById("indent-size");
      const editorContainer = document.getElementById("editor-container");
      const resizeBar = document.getElementById("resize-bar");
      const canvasContainer = document.getElementById("canvas-container");
      const toggleCanvasBtn = document.getElementById("toggle-canvas");
      const fullscreenCanvasBtn = document.getElementById("fullscreen-canvas");
      const expandBtn = document.getElementById("expand-button");

      let isResizing = false;
      let startX = 0;
      let startWidth = 0;
      let canvasHidden = false;

      function getIndent() {
        const val = indentSelect.value;
        if (val === "tab") return "\t";
        return " ".repeat(parseInt(val, 10));
      }

      // EnterÊôÇ„Ç§„É≥„Éá„É≥„ÉàÔºàÈñâ„ÅòÊã¨Âºß„ÅßÊ∏õ„Çâ„ÅôÔºâ
      textarea.addEventListener("keydown", (e) => {
        if (e.key === ")" || e.key === "}" || e.key === "]") {
          e.preventDefault();
          const start = textarea.selectionStart;
          const end = textarea.selectionEnd;
          const before = textarea.value.substring(0, start);
          const after = textarea.value.substring(end);
          const lineStart = before.lastIndexOf("\n") + 1;
          const currentLine = before.substring(lineStart);
          let baseIndent = currentLine.match(/^\s*/)[0] || "";
          
          if (/^[\t ]*$/.test(currentLine)) {
            textarea.value = before.slice(0, -getIndent().length) + e.key + after;
            const pos = start - getIndent().length + 1;
            textarea.selectionStart = textarea.selectionEnd = pos;
          } else {
            textarea.value = before + e.key + after;
            const pos = start + 1;
            textarea.selectionStart = textarea.selectionEnd = pos;
          }
          

          
        }
        if (e.key === "Enter") {
          e.preventDefault();
          const start = textarea.selectionStart;
          const end = textarea.selectionEnd;
          const before = textarea.value.substring(0, start);
          const after = textarea.value.substring(end);
          const lineStart = before.lastIndexOf("\n") + 1;
          const currentLine = before.substring(lineStart);
          let baseIndent = currentLine.match(/^\s*/)[0] || "";
          let extraIndent = "";

          const trimmed = currentLine.trimEnd();
          if (trimmed.endsWith("{") || trimmed.endsWith("(") || trimmed.endsWith("[")) {
            extraIndent = getIndent();
          }

          const insert = "\n" + baseIndent + extraIndent;
          textarea.value = before + insert + after;
          const pos = start + insert.length;
          textarea.selectionStart = textarea.selectionEnd = pos;
        }
      });

      // PasteÊôÇ„Ç§„É≥„Éá„É≥„ÉàË™øÊï¥
      textarea.addEventListener("paste", (e) => {
        e.preventDefault();
        const pasteText = (e.clipboardData || window.clipboardData).getData('text');
        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        const before = textarea.value.substring(0, start);
        const after = textarea.value.substring(end);
        const lineStart = before.lastIndexOf("\n") + 1;
        const currentLine = before.substring(lineStart);
        const baseIndent = currentLine.match(/^\s*/)[0] || "";

        const lines = pasteText.split("\n");
        let minIndent = Infinity;
        lines.forEach(line => {
          const m = line.match(/^(\s*)\S/);
          if (m) minIndent = Math.min(minIndent, m[1].length);
        });
        if (!isFinite(minIndent)) minIndent = 0;

        const newLines = lines.map((line, i) => {
          if (i === 0) return line;
          return baseIndent + line.substring(minIndent);
        });

        const insertText = newLines.join("\n");
        textarea.value = before + insertText + after;
        const pos = start + insertText.length;
        textarea.selectionStart = textarea.selectionEnd = pos;
      });

      // „Ç≥„Éî„Éº
      copyBtn.addEventListener("click", () => {
        textarea.select();
        document.execCommand("copy");
        alert("„Ç≥„Éº„Éâ„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü");
      });

      // ‰øùÂ≠ò
      saveBtn.addEventListener("click", () => {
        localStorage.setItem("threejs-editor-code", textarea.value);
        alert("„Ç≥„Éº„Éâ„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü");
      });

      // Âëº„Å≥Âá∫„Åó
      loadBtn.addEventListener("click", () => {
        const saved = localStorage.getItem("threejs-editor-code");
        if (saved !== null) {
          textarea.value = saved;
          alert("‰øùÂ≠ò„Åó„Åü„Ç≥„Éº„Éâ„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü");
        } else {
          alert("‰øùÂ≠ò„Åï„Çå„Åü„Ç≥„Éº„Éâ„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì");
        }
      });

      // „Éâ„É©„ÉÉ„Ç∞ÂπÖË™øÊï¥
      const startResize = (clientX) => {
        isResizing = true;
        startX = clientX;
        startWidth = editorContainer.offsetWidth;
        document.body.style.cursor = "ew-resize";
      };
      resizeBar.addEventListener("mousedown", (e) => startResize(e.clientX));
      resizeBar.addEventListener("touchstart", (e) => startResize(e.touches[0].clientX));

      const doResize = (clientX) => {
        if (!isResizing) return;
        let newWidth = startWidth + (clientX - startX);
        if (newWidth < 100) newWidth = 100;
        if (newWidth > window.innerWidth - 100) newWidth = window.innerWidth - 100;
        editorContainer.style.width = newWidth + "px";
        canvasContainer.style.width = (window.innerWidth - newWidth) + "px";
      };
      document.addEventListener("mousemove", (e) => doResize(e.clientX));
      document.addEventListener("touchmove", (e) => doResize(e.touches[0].clientX));
      const stopResize = () => {
        isResizing = false;
        document.body.style.cursor = "default";
      };
      document.addEventListener("mouseup", stopResize);
      document.addEventListener("touchend", stopResize);

      function run(){
        consoleDiv.textContent = "";
        const userCode = textarea.value;
        const iframeDoc = preview.contentDocument || preview.contentWindow.document;
        iframeDoc.open();
        iframeDoc.write(`
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="UTF-8">
            <style>body{margin:0;overflow:hidden;}</style>
          </head>
          <body>
            <script type="importmap">
            {
              "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.175.0/build/three.module.js"
              }
            }
            <\/script>
            <script>
              (function(){
                const log = (...args) => parent.postMessage({type:"log", msg: args.join(" ")}, "*");
                const error = (...args) => parent.postMessage({type:"error", msg: args.join(" ")}, "*");
                console.log = log;
                console.error = error;
                console.warn = log;
                console.info = log;
                window.onerror = (m,s,l,c,e) => {
                  parent.postMessage({type:"error", msg: m + " ("+s+":"+l+")"}, "*");
                };
              })();
            <\/script>
            <script type="module">
              ${userCode}
            <\/script>
          </body>
          </html>
        `);
        iframeDoc.close();
      }

      runBtn.addEventListener("click", run);
      clearBtn.addEventListener("click", () => { consoleDiv.textContent = ""; });
      window.addEventListener("message", (e) => {
        if (e.data.type === "log") consoleDiv.textContent += e.data.msg + "\n";
        if (e.data.type === "error") consoleDiv.textContent += "[„Ç®„É©„Éº] " + e.data.msg + "\n";
        consoleDiv.scrollTop = consoleDiv.scrollHeight;
      });

      // Êäò„Çä„Åü„Åü„Åø
      toggleCanvasBtn.addEventListener("click", () => {
        canvasHidden = true;
        editorContainer.style.width = "100%";
        canvasContainer.style.width = "0";
        resizeBar.style.opacity = 0;
        expandBtn.style.display = "block";
      });

      // Â±ïÈñã
      expandBtn.addEventListener("click", () => {
        canvasHidden = false;
        expandBtn.style.display = "none";
        resizeBar.style.opacity = 1;
        editorContainer.style.width = "50%";
        canvasContainer.style.width = "50%";

        const onTransitionEnd = (e) => {
          if (e.propertyName === "width") {
            run();
            editorContainer.removeEventListener("transitionend", onTransitionEnd);
          }
        };
        editorContainer.addEventListener("transitionend", onTransitionEnd);
      });

      // ÂÖ®ÁîªÈù¢
      fullscreenCanvasBtn.addEventListener("click", () => {
        if (preview.requestFullscreen) preview.requestFullscreen();
        else if (preview.webkitRequestFullscreen) preview.webkitRequestFullscreen();
        else if (preview.msRequestFullscreen) preview.msRequestFullscreen();
        run();
      });

      // „É™„Çµ„Ç§„Ç∫ÊôÇ„ÇÇÂÜçÂÆüË°å
      window.addEventListener("resize", () => { run(); });

      run();
    </script>
  </body>
</html>

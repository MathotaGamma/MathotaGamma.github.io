<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <title>WebRTC QR P2P RTT</title>
    <style>
      body { font-family: sans-serif; margin: 20px; }
      #qrcode, #video { border: 1px solid #ccc; margin: 10px 0; }
      textarea { width: 100%; height: 100px; }
      #log { white-space: pre-wrap; border: 1px solid #ccc; padding: 10px; height: 150px; overflow-y: auto; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
  </head>
  <body>
    <h2>WebRTC QR P2P RTT</h2>

    <button id="createOffer">Offer 作成</button>
    <button id="createAnswer">Answer 作成</button>
    <button id="sendTime">Time 送信</button>

    <canvas id="qrcode"></canvas>
    <div id="video" style="width:300px;height:200px;"></div>

    <div id="log"></div>

    <script>
      const logEl = document.getElementById('log');
      function log(msg){ logEl.textContent += msg + "\n"; logEl.scrollTop = logEl.scrollHeight; }

      let pc = new RTCPeerConnection();
      let channel;

      // DataChannel 受信設定
      pc.ondatachannel = (e)=>{
        channel = e.channel;
        channel.onopen = ()=>log('DataChannel open (受信側)');
        channel.onmessage = (msg)=>{
          const recv = JSON.parse(msg.data);
          if(recv.type==='time'){
            const rtt = Date.now()-recv.timestamp;
            log(`遅延(RTT): ${rtt} ms`);
          }
        };
      };

      // QR コード生成
      function showQR(text){ QRCode.toCanvas(document.getElementById('qrcode'), text, {width:300}); }

      // Webカメラ読み取り
      let html5QrcodeScanner = new Html5Qrcode("video");
      function scanQR(callback){
        html5QrcodeScanner.start(
          { facingMode: "environment" },
          { fps: 10, qrbox: 250 },
          (decoded)=>{
            callback(decoded);
            html5QrcodeScanner.stop();
          },
          (err)=>{}
        );
      }

      // Offer 作成
      document.getElementById('createOffer').onclick = async ()=>{
        channel = pc.createDataChannel('timeChannel');
        channel.onopen = ()=>log('DataChannel open (作成側)');
        channel.onmessage = (msg)=>{
          const recv = JSON.parse(msg.data);
          if(recv.type==='time'){
            const rtt = Date.now()-recv.timestamp;
            log(`遅延(RTT): ${rtt} ms`);
          }
        };
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        showQR(JSON.stringify(pc.localDescription));
        log('Offer 作成完了。QR を相手に読ませてください。');
      };

      // Answer 作成
      document.getElementById('createAnswer').onclick = async ()=>{
        log('相手の QR を読み取ります...');
        scanQR(async (decoded)=>{
          await pc.setRemoteDescription(JSON.parse(decoded));
          const answer = await pc.createAnswer();
          await pc.setLocalDescription(answer);
          showQR(JSON.stringify(pc.localDescription));
          log('Answer 作成完了。QR を相手に読ませてください。');
        });
      };

      // Time 送信
      document.getElementById('sendTime').onclick = ()=>{
        if(channel && channel.readyState==='open'){
          channel.send(JSON.stringify({type:'time', timestamp: Date.now()}));
          log('Time 送信完了');
        } else log('DataChannel が未接続');
      };
    </script>
  </body>
</html>
